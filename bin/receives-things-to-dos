#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative '../thaings'

RECEIVE_LOG = THAINGS_ROOT / 'log' / 'receive.log'

# Receives a Things to-do via stdin JSON, creates/updates to-do state
#
# Usage (from Shortcuts):
#   echo '{"Type":"To-Do","ID":"abc123","Title":"..."}' | receives-things-to-dos
#
class ReceivesThingsToDo
  attr_reader :input, :log

  def initialize(input, log: Log.new(RECEIVE_LOG))
    @input = input
    @log = log
  end

  def call
    return unless valid?

    to_do = ToDo.find_or_create(id)
    to_do.append_props(data)
    to_do.save!

    log.write('receive', "#{id} - #{title}")
    Log.new(to_do.log_file).write('receive', 'Props received from Things')
  end

  private

  def valid?
    return false unless data['Type'] == 'To-Do'

    if id.nil? || id.empty?
      $stderr.puts 'Missing ID field'
      exit 1
    end

    true
  end

  def data
    @data ||= parse_json
  end

  def parse_json
    JSON.parse(input)
  rescue JSON::ParserError => e
    $stderr.puts "Invalid JSON: #{e.message}"
    exit 1
  end

  def id
    data['ID']
  end

  def title
    data['Title'] || '(no title)'
  end
end

input = $stdin.read.force_encoding('UTF-8').strip
ReceivesThingsToDo.new(input).call
