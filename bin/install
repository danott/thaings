#!/usr/bin/env ruby
# frozen_string_literal: true

require "json"
require "pathname"
require "uri"

# Sets up Thaings: creates onboarding to-do in Things and loads daemon
#
# Usage:
#   ./bin/install
#

HOME_DIR = Pathname(Dir.home)
THAINGS_ROOT = Pathname(__FILE__).dirname.parent.expand_path
PLIST_TEMPLATE =
  THAINGS_ROOT / "LaunchAgents" / "com.thaings.daemon.plist.example"
PLIST_GENERATED = THAINGS_ROOT / "LaunchAgents" / "com.thaings.daemon.plist"
PLIST_DEST = HOME_DIR / "Library" / "LaunchAgents" / "com.thaings.daemon.plist"
ENV_FILE = THAINGS_ROOT / ".env"
ENV_TEMPLATE = "THINGS_AUTH_TOKEN=paste-your-token-here\n"

NOTES = <<~NOTES
  Welcome to Thaings! Follow these steps to augment your to-dos with agentic workers.

  ## 1. Create tags

  Create these tags manually (⌃⌘T or Window → Tags):

  1. `Working`
  2. `Ready`

  ## 2. Enable Things URLs

  Things → Settings → General → Enable Things URLs.

  Click "Manage" and copy your auth token.

  ## 3. Save auth token

  Paste your token into `.env` so Thaings can update your to-dos.

  [Reveal .env in Finder](file://#{THAINGS_ROOT}/.env)

  ## 4. Install shortcut

  The Apple Shortcut is how you will send to-dos from Things to Thaings.

  [Reveal shortcut in Finder](file://#{THAINGS_ROOT}/Thaings.shortcut) → double-click to install.

  ## 5. Know the caveats

  1. **Collapse to-dos before calling the shortcut.** Things' "Get Selected Items" returns unpredictable data when a to-do is open for editing.
  2. **Don't edit to-dos while Thaings is working.** Things' URL scheme updates are unpredictable when the notes field is focused. Let the to-do rest until it's tagged `Ready`.

  Go for a walk. Write a poem. The world is out there while the agents are working in here!

  ## 6. Try it out!

  Check off the items below, collapse this to-do, and run the Thaings shortcut. Watch the tag change from `Working` to `Ready`, then re-open to see what Thaings responded with!
NOTES

def checklist_item(title)
  { "type" => "checklist-item", "attributes" => { "title" => title } }
end

INSTALL_DATA = [
  {
    "type" => "to-do",
    "attributes" => {
      "title" => "Finish setting up Thaings...",
      "notes" => NOTES,
      "checklist-items" => [
        checklist_item("Tags created"),
        checklist_item("Things URLs enabled"),
        checklist_item("Auth token saved"),
        checklist_item("Shortcut installed"),
        checklist_item("Ready to test")
      ]
    }
  }
].freeze

def install
  puts "Setting up Thaings..."

  # Create .env template if it doesn't exist
  unless ENV_FILE.exist?
    ENV_FILE.write(ENV_TEMPLATE)
    puts "Created .env template"
  end

  # Generate plist from template
  puts "Generating LaunchAgent plist..."
  plist_content =
    PLIST_TEMPLATE.read.gsub("__THAINGS_ROOT__", THAINGS_ROOT.to_s).gsub(
      "__HOME__",
      HOME_DIR.to_s
    )
  PLIST_GENERATED.write(plist_content)

  # Load daemon
  puts "Loading daemon..."
  unless system("ln", "-sf", PLIST_GENERATED.to_s, PLIST_DEST.to_s)
    warn "Warning: Failed to create symlink"
  end
  system("launchctl", "unload", PLIST_DEST.to_s, err: File::NULL) # May fail if not loaded, that's OK
  unless system("launchctl", "load", PLIST_DEST.to_s)
    warn "Warning: Failed to load LaunchAgent"
  end

  # Create to-do in Things
  puts "Creating setup checklist in Things..."
  json = JSON.generate(INSTALL_DATA)
  encoded = URI.encode_www_form_component(json).gsub("+", "%20")
  unless system("open", "-g", "things:///json?data=#{encoded}")
    warn "Warning: Failed to open Things"
  end
  system("open", "-g", "things:///show?id=inbox")
  puts "Visit your Things Inbox to finish setting up Thaings."
end

install
